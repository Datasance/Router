name: CI
on:
  push:
    branches:
      - main
    tags: [v*]
    paths-ignore:
      - README.md
      - CHANGELOG.md
      - LICENSE
  pull_request:
    branches:
      - main
    paths-ignore:
      - README.md
      - CHANGELOG.md
      - LICENSE
env:
  IMAGE_NAME: 'router'
  ADAPTOR_IMAGE_NAME: 'router-adaptor'

jobs:
  version:
    name: Set version
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      VERSION: ${{ steps.tags.outputs.VERSION }}
    steps:
      - uses: actions/checkout@v4
      - name: Get Previous tag
        id: previoustag
        uses: "WyriHaximus/github-action-get-previous-tag@v1"
        with:
          fallback: 0.0.0
      - name: Set image tag
        shell: bash
        id: tags
        run: |
          if [[ ${{ github.ref_name }} =~ ^v.* ]] ; then
            VERSION=${{ github.ref_name }}
            echo "VERSION=${VERSION:1}" >> "${GITHUB_OUTPUT}"
          else
            VERSION=${{ steps.previoustag.outputs.tag }}
            echo "VERSION=${VERSION:1}-${{ github.run_number }}" >> "${GITHUB_OUTPUT}"
          fi

  build_amd64:
    name: Build amd64
    needs: version
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to Github Container Registry
        uses: docker/login-action@v3
        with:
          registry: "ghcr.io"
          username: ${{ github.actor }}
          password: ${{ secrets.PAT }}
      - name: Build and push amd64 image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          platforms: linux/amd64
          push: ${{ github.event_name == 'push' }}
          tags: |
            ghcr.io/datasance/${{ env.IMAGE_NAME }}:build-${{ github.run_id }}-amd64

  build_arm64:
    name: Build arm64
    needs: version
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to Github Container Registry
        uses: docker/login-action@v3
        with:
          registry: "ghcr.io"
          username: ${{ github.actor }}
          password: ${{ secrets.PAT }}
      - name: Build and push arm64 image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          platforms: linux/arm64
          push: ${{ github.event_name == 'push' }}
          tags: |
            ghcr.io/datasance/${{ env.IMAGE_NAME }}:build-${{ github.run_id }}-arm64

  merge_manifest:
    name: Merge multi-platform manifest
    needs: [version, build_amd64, build_arm64]
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Login to Github Container Registry
        uses: docker/login-action@v3
        with:
          registry: "ghcr.io"
          username: ${{ github.actor }}
          password: ${{ secrets.PAT }}
      - name: Create and push multi-platform manifest
        run: |
          docker buildx imagetools create \
            -t ghcr.io/datasance/${{ env.IMAGE_NAME }}:${{ needs.version.outputs.VERSION }} \
            -t ghcr.io/datasance/${{ env.IMAGE_NAME }}:latest \
            -t ghcr.io/datasance/${{ env.IMAGE_NAME }}:main \
            ghcr.io/datasance/${{ env.IMAGE_NAME }}:build-${{ github.run_id }}-amd64 \
            ghcr.io/datasance/${{ env.IMAGE_NAME }}:build-${{ github.run_id }}-arm64
